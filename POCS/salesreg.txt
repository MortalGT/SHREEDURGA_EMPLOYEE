REPORT zsdr_sales_report_test.

TABLES : vbrk, vbrp, wb2_v_vbrk_vbrp2, vbak.

DATA : it_wb2_v_vbrk_vbrp2 TYPE STANDARD TABLE OF wb2_v_vbrk_vbrp2,
       wa_wb2_v_vbrk_vbrp2 TYPE wb2_v_vbrk_vbrp2.

TYPES : BEGIN OF ty_data,
          werks        TYPE vbrp-werks,
          bupla        TYPE wb2_v_vbrk_vbrp2-bupla,
          fkdat        TYPE vbrk-fkdat,
          fkart        TYPE vbrk-fkart,
          xblnr        TYPE vbrk-xblnr,
          vbeln        TYPE vbrp-vbeln,
          posnr        TYPE vbrp-posnr,
          vgbel        TYPE vbrp-vgbel,
          bldat        TYPE likp-bldat,
          vgpos        TYPE vbrp-vgbel,
          aubel        TYPE vbrp-aubel,
          aupos        TYPE vbrp-aupos,
          kunag        TYPE vbrk-kunag,
          name1        TYPE kna1-name1,
          matnr        TYPE vbrp-matnr,
          arktx        TYPE vbrp-arktx,
          charg        TYPE vbrp-charg,
          fkimg        TYPE vbrp-fkimg,
          vrkme        TYPE vbrp-vrkme,
          kursk        TYPE vbrk-kurrf,
          rate         TYPE kbetr,
          netwr        TYPE wb2_v_vbrk_vbrp2-netwr_i,
          mwsbp        TYPE wb2_v_vbrk_vbrp2-mwsbp_i,
          tot_price    TYPE vbrp-netwr,
          stcd3        TYPE kna1-stcd3,
          steuc        TYPE marc-steuc,
          cgst         TYPE konv-kbetr,
          sgst         TYPE konv-kbetr,
          ugst         TYPE konv-kbetr,
          igst         TYPE konv-kbetr,
          jtc1         TYPE konv-kbetr,
          jtc2         TYPE konv-kbetr,

          cgstr        TYPE konv-kbetr,
          sgstr        TYPE konv-kbetr,
          ugstr        TYPE konv-kbetr,
          igstr        TYPE konv-kbetr,
          jtc1r        TYPE konv-kbetr,
          jtc2r        TYPE konv-kbetr,

          zterm        TYPE vbrk-zterm,
          d_shade_no   TYPE v_ibin_syval-atwrt,
          d_shade_name TYPE v_ibin_syval-atwrt,
          irn          TYPE j_1ig_invrefnum-irn,
          ack_no       TYPE j_1ig_invrefnum-ack_no,
          ack_date     TYPE j_1ig_invrefnum-ack_date,
          ebillno      TYPE j_1ig_ewaybill-ebillno,

          exidv        TYPE vekp-exidv,
          exidv2       TYPE vekp-exidv2,
          vegr1        TYPE vekp-vegr1,
          vemng        TYPE vepo-vemng,
          kunnr        TYPE kna1-kunnr,
          extwg        TYPE mara-extwg,
          zname1       TYPE kna1-name1,
        END OF ty_data.
DATA : it_data TYPE STANDARD TABLE OF ty_data,
       wa_data TYPE ty_data.

TYPES : BEGIN OF ty_likp,
          vbeln  TYPE likp-vbeln,
          objkey TYPE vevw-objkey,
        END OF ty_likp.
DATA : it_likp TYPE STANDARD TABLE OF ty_likp,
       wa_likp TYPE ty_likp.

DATA : ls_fcat   TYPE slis_fieldcat_alv,
       lt_fcat   TYPE slis_t_fieldcat_alv,
       ls_layout TYPE slis_layout_alv.

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
  SELECT-OPTIONS : s_fkdat FOR vbrk-fkdat OBLIGATORY,
                   s_bukrs FOR vbrk-bukrs,
                   s_werks FOR vbrp-werks,
                   s_fkart FOR vbrk-fkart,
                   s_matnr FOR wb2_v_vbrk_vbrp2-matnr_i,
                   s_kunag FOR wb2_v_vbrk_vbrp2-kunag,
                   s_vbeln FOR vbrk-vbeln,
                   s_aubel FOR vbak-vbeln,
                   s_vkorg FOR vbrk-vkorg,
                   s_vtweg FOR vbrk-vtweg.
SELECTION-SCREEN END OF BLOCK b1.

START-OF-SELECTION.

  SELECT * FROM t001w INTO TABLE @DATA(it_t001w)
    WHERE werks IN @s_werks
    AND   vkorg IN @s_vkorg
    AND   vkorg IN @s_bukrs.
  REFRESH : s_werks[].
  LOOP AT it_t001w INTO DATA(wa_t001w).
    AUTHORITY-CHECK OBJECT 'ZOBJ_WERKS'
     ID 'WERKS' FIELD wa_t001w-werks.
    IF sy-subrc = 0.
      s_werks-sign   = 'I'.
      s_werks-option = 'EQ'.
      s_werks-low    = wa_t001w-werks.
      s_werks-high   = wa_t001w-werks.
      APPEND s_werks.
      CLEAR s_werks.
    ENDIF.
  ENDLOOP.

  REFRESH : it_wb2_v_vbrk_vbrp2[], it_data[].
  SELECT * FROM wb2_v_vbrk_vbrp2
    WHERE fkdat   IN @s_fkdat
    AND   bukrs   IN @s_bukrs
    AND   werks_i IN @s_werks
    AND   fkart   IN @s_fkart
    AND   kunag   IN @s_kunag
    AND   vbeln   IN @s_vbeln
    AND   aubel_i IN @s_aubel
    AND   vkorg   IN @s_vkorg
    AND   vtweg   IN @s_vtweg
    AND   fksto = ''
    AND   sfakn = ''
    AND   fkimg_i IS NOT INITIAL
    AND   matnr_i IN @s_matnr
    INTO TABLE @it_wb2_v_vbrk_vbrp2.

  IF it_wb2_v_vbrk_vbrp2[] IS NOT INITIAL.

    SELECT vbeln , kunnr, parvw
    FROM vbpa INTO TABLE @DATA(lt_vbpa_bp)
    FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
    WHERE vbeln = @it_wb2_v_vbrk_vbrp2-vbeln.

    IF lt_vbpa_bp[] IS NOT INITIAL .
      SELECT bahne,
             bahns,
             kunnr,
             name1
       FROM kna1 INTO TABLE @DATA(lt_kna1_bp)
       FOR ALL ENTRIES IN @lt_vbpa_bp
       WHERE kunnr =  @lt_vbpa_bp-kunnr.
      IF lt_kna1_bp[] IS NOT INITIAL .

        SELECT lifnr,
               name1
          FROM lfa1 INTO TABLE @DATA(lt_lfa1_bp)
          FOR ALL ENTRIES IN @lt_kna1_bp
          WHERE lifnr = @lt_kna1_bp-bahne+0(10)
          OR lifnr = @lt_kna1_bp-bahns+0(10).

      ENDIF.
    ENDIF.
    
    SELECT * FROM mara INTO TABLE @DATA(it_mara)
    FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
    WHERE matnr = @it_wb2_v_vbrk_vbrp2-matnr_i.


    SELECT * FROM prcd_elements
      FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
      WHERE knumv = @it_wb2_v_vbrk_vbrp2-knumv
      AND   kbetr IS NOT INITIAL
      AND   kschl IN ( 'PR00', 'ZCIF', 'ZSTO', 'ZJWC',
                       'JOCG', 'JOSG', 'JOUG', 'JOIG', 'JTC1', 'JTC2' ,'ZPQ1' )
      INTO TABLE @DATA(it_prcd).
    SORT it_prcd BY knumv kposn kschl.

    SELECT kunnr, name1, stcd3 FROM kna1 INTO TABLE @DATA(it_kna1)
      FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
      WHERE kunnr = @it_wb2_v_vbrk_vbrp2-kunag.
    SORT it_kna1 BY kunnr.

    SELECT matnr, werks, steuc FROM marc INTO TABLE @DATA(it_marc)
      FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
      WHERE matnr = @it_wb2_v_vbrk_vbrp2-matnr_i
      AND   werks = @it_wb2_v_vbrk_vbrp2-werks_i.
    SORT it_marc BY matnr werks.

    SELECT * FROM j_1ig_invrefnum
      FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
      WHERE bukrs = @it_wb2_v_vbrk_vbrp2-bukrs
      AND   docno = @it_wb2_v_vbrk_vbrp2-vbeln
      AND   irn_status = 'ACT'
      INTO TABLE @DATA(it_j_1ig_invrefnum).

    SELECT * FROM j_1ig_ewaybill
      FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
      WHERE bukrs = @it_wb2_v_vbrk_vbrp2-bukrs
      AND   docno = @it_wb2_v_vbrk_vbrp2-vbeln
      AND   status NE 'C'
      INTO TABLE @DATA(it_j_1ig_ewaybill).

    SELECT * FROM ibin INTO TABLE @DATA(it_ibin)
      FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
      WHERE instance = @it_wb2_v_vbrk_vbrp2-cuobj_i.
    SORT it_ibin BY instance.

    IF it_ibin[] IS NOT INITIAL.
      SELECT a~in_recno, a~atinn, a~atwrt, b~atnam
        FROM v_ibin_syval AS a
        JOIN cabn AS b
        ON ( b~atinn = a~atinn )
        INTO TABLE @DATA(it_v_ibin_syval)
        FOR ALL ENTRIES IN @it_ibin
        WHERE a~in_recno = @it_ibin-in_recno
        AND ( b~atnam = 'D_SHADE_NO' OR b~atnam = 'D_SHADE_NAME' ).
      SORT it_v_ibin_syval BY in_recno atnam.
    ENDIF.

    IF it_wb2_v_vbrk_vbrp2[] IS NOT INITIAL.
      SELECT * FROM knvp INTO TABLE @DATA(it_knvp) FOR ALL ENTRIES IN @it_wb2_v_vbrk_vbrp2
        WHERE kunnr = @it_wb2_v_vbrk_vbrp2-kunag
        AND   parvw = 'ES'.
    ENDIF.

  ENDIF.

  LOOP AT it_wb2_v_vbrk_vbrp2 INTO wa_wb2_v_vbrk_vbrp2.

    wa_data-werks      = wa_wb2_v_vbrk_vbrp2-werks_i.
    wa_data-bupla      = wa_wb2_v_vbrk_vbrp2-bupla.
    wa_data-fkdat      = wa_wb2_v_vbrk_vbrp2-fkdat.
    wa_data-fkart      = wa_wb2_v_vbrk_vbrp2-fkart.
    wa_data-xblnr      = wa_wb2_v_vbrk_vbrp2-xblnr.
    wa_data-vbeln      = wa_wb2_v_vbrk_vbrp2-vbeln.
    wa_data-posnr      = wa_wb2_v_vbrk_vbrp2-posnr_i.
    wa_data-vgbel      = wa_wb2_v_vbrk_vbrp2-vgbel_i.
    wa_data-vgpos      = wa_wb2_v_vbrk_vbrp2-vgpos_i.
    wa_data-aubel      = wa_wb2_v_vbrk_vbrp2-aubel_i.
    wa_data-aupos      = wa_wb2_v_vbrk_vbrp2-aupos_i.
    wa_data-kunag      = wa_wb2_v_vbrk_vbrp2-kunag.
    wa_data-vrkme      = wa_wb2_v_vbrk_vbrp2-vrkme_i.

    SELECT SINGLE bldat FROM likp WHERE vbeln = @wa_wb2_v_vbrk_vbrp2-vgbel_i INTO  @wa_data-bldat.
    IF wa_data-fkart = 'ZEXP'.
      IF wa_data-aubel IS NOT INITIAL.
      ENDIF.
    ENDIF.

    READ TABLE it_kna1 INTO DATA(wa_kna1) WITH KEY kunnr = wa_wb2_v_vbrk_vbrp2-kunag BINARY SEARCH.
    IF sy-subrc = 0.
      wa_data-name1      = wa_kna1-name1.
      wa_data-stcd3      = wa_kna1-stcd3.
    ENDIF.

    wa_data-matnr      = wa_wb2_v_vbrk_vbrp2-matnr_i.
    wa_data-arktx      = wa_wb2_v_vbrk_vbrp2-arktx_i.
    wa_data-charg      = wa_wb2_v_vbrk_vbrp2-charg_i.
    wa_data-zterm      = wa_wb2_v_vbrk_vbrp2-zterm.

    READ TABLE it_knvp INTO DATA(wa_knvp) WITH KEY kunnr = wa_wb2_v_vbrk_vbrp2-kunag
                                                   vkorg = wa_wb2_v_vbrk_vbrp2-vkorg.


    READ TABLE it_marc INTO DATA(wa_marc) WITH KEY matnr = wa_wb2_v_vbrk_vbrp2-matnr_i
                                                   werks = wa_wb2_v_vbrk_vbrp2-werks_i BINARY SEARCH.
    IF sy-subrc = 0.
      wa_data-steuc      = wa_marc-steuc.
    ENDIF.

    READ TABLE it_mara INTO DATA(wa_mara) WITH KEY matnr = wa_wb2_v_vbrk_vbrp2-matnr_i.
    IF sy-subrc = 0.
      wa_data-extwg      = wa_mara-extwg.
    ENDIF.

    READ TABLE it_j_1ig_invrefnum INTO DATA(wa_j_1ig_invrefnum) WITH KEY docno = wa_wb2_v_vbrk_vbrp2-vbeln.
    IF sy-subrc = 0.
      wa_data-irn      = wa_j_1ig_invrefnum-irn.
      wa_data-ack_no   = wa_j_1ig_invrefnum-ack_no.
      wa_data-ack_date = wa_j_1ig_invrefnum-ack_date.
    ENDIF.

    READ TABLE it_j_1ig_ewaybill INTO DATA(wa_j_1ig_ewaybill) WITH KEY docno = wa_wb2_v_vbrk_vbrp2-vbeln.
    IF sy-subrc = 0.
      wa_data-ebillno  = wa_j_1ig_ewaybill-ebillno.
    ENDIF.

    READ TABLE it_ibin INTO DATA(wa_ibin) WITH KEY instance = wa_wb2_v_vbrk_vbrp2-cuobj_i BINARY SEARCH.
    IF sy-subrc = 0.
      READ TABLE it_v_ibin_syval INTO DATA(wa_v_ibin_syval) WITH KEY in_recno = wa_ibin-in_recno
                                                                     atnam = 'D_SHADE_NO' BINARY SEARCH.
      IF sy-subrc = 0.
        wa_data-d_shade_no = wa_v_ibin_syval-atwrt.
      ENDIF.

      READ TABLE it_v_ibin_syval INTO wa_v_ibin_syval WITH KEY in_recno = wa_ibin-in_recno
                                                                     atnam = 'D_SHADE_NAME' BINARY SEARCH.
      IF sy-subrc = 0.
        wa_data-d_shade_name = wa_v_ibin_syval-atwrt.
      ENDIF.
    ENDIF.

    READ TABLE lt_vbpa_bp INTO DATA(lw_vbpa_ag) WITH KEY vbeln = wa_wb2_v_vbrk_vbrp2-vbeln
                                                          parvw = 'WE'.
    IF sy-subrc  = 0.
      READ TABLE lt_kna1_bp INTO DATA(lw_kna1_ag) WITH KEY kunnr = lw_vbpa_ag-kunnr.
      IF sy-subrc = 0.
        wa_data-kunnr      = lw_kna1_ag-kunnr.
        wa_data-zname1 = lw_kna1_ag-name1.
      ENDIF.
    ENDIF.

    CLEAR:lw_vbpa_ag,lw_kna1_ag.

    wa_data-fkimg      = wa_wb2_v_vbrk_vbrp2-fkimg_i.
    wa_data-kursk      = wa_wb2_v_vbrk_vbrp2-kurrf.
    wa_data-netwr      = wa_wb2_v_vbrk_vbrp2-netwr_i * wa_wb2_v_vbrk_vbrp2-kurrf.
    wa_data-mwsbp      = wa_wb2_v_vbrk_vbrp2-mwsbp_i * wa_wb2_v_vbrk_vbrp2-kurrf.
    wa_data-tot_price  = wa_data-netwr + wa_data-mwsbp.

    LOOP AT it_prcd INTO DATA(wa_prcd) WHERE knumv = wa_wb2_v_vbrk_vbrp2-knumv
                                        AND  kposn = wa_wb2_v_vbrk_vbrp2-posnr_i.

      IF wa_prcd-kschl EQ 'ZPQ1' AND wa_prcd-kinak NE 'Y'.
        wa_data-rate = wa_prcd-kbetr  * wa_wb2_v_vbrk_vbrp2-kurrf.
      ELSE.

        CASE wa_prcd-kschl.
          WHEN 'PR00' OR 'ZCIF' OR 'ZSTO' OR 'ZJWC'.
            wa_data-rate = wa_prcd-kbetr  * wa_wb2_v_vbrk_vbrp2-kurrf.
          WHEN 'JOCG'.
            wa_data-cgst = wa_prcd-kwert * wa_wb2_v_vbrk_vbrp2-kurrf.
            wa_data-cgstr = wa_prcd-kbetr * wa_wb2_v_vbrk_vbrp2-kurrf.
          WHEN 'JOSG'.
            wa_data-sgst = wa_prcd-kwert * wa_wb2_v_vbrk_vbrp2-kurrf.
            wa_data-sgstr = wa_prcd-kbetr * wa_wb2_v_vbrk_vbrp2-kurrf.
          WHEN 'JOUG'.
            wa_data-ugst = wa_prcd-kwert * wa_wb2_v_vbrk_vbrp2-kurrf.
            wa_data-ugstr = wa_prcd-kbetr * wa_wb2_v_vbrk_vbrp2-kurrf.
          WHEN 'JOIG'.
            wa_data-igst = wa_prcd-kwert * wa_wb2_v_vbrk_vbrp2-kurrf.
            wa_data-igstr = wa_prcd-kbetr * wa_wb2_v_vbrk_vbrp2-kurrf.
          WHEN 'JTC1'.
            wa_data-jtc1 = wa_prcd-kwert * wa_wb2_v_vbrk_vbrp2-kurrf.
            wa_data-jtc1r = wa_prcd-kbetr * wa_wb2_v_vbrk_vbrp2-kurrf.
          WHEN 'JTC2'.
            wa_data-jtc2 = wa_prcd-kwert * wa_wb2_v_vbrk_vbrp2-kurrf.
            wa_data-jtc2r = wa_prcd-kbetr * wa_wb2_v_vbrk_vbrp2-kurrf.
        ENDCASE.

      ENDIF.
    ENDLOOP.

    APPEND wa_data TO it_data.
    CLEAR wa_data.


    CLEAR wa_data.

  ENDLOOP.


  PERFORM fcat USING  : 'WERKS' 'Plant' '' '',
                        'BUPLA' 'Bus.Place' '' '',
                        'FKDAT' 'Billing Date' '' 'VBRK',
                        'FKART' 'Bill Type' ' ' '',
                        'XBLNR' 'ODN No' '' '',
                        'VBELN' 'Bill No' '' 'VBRK',
                        'POSNR' 'Bill Item No' '' 'VBRP',
                        'VGBEL' 'Delivery No.' '' '',
                        'VGPOS' 'Del.Item No' '' '',
                        'AUBEL' 'SO No' '' 'VBRP',
                        'AUPOS' 'SO Item' '' 'VBRP',
                        'PI_NUM' 'Contract No.' '' 'VBAK',
                        'KUNAG' 'Sold To Party' '' 'VBRK',
                        'NAME1' 'Name' '' '',
                        'STCD3' 'GSTIN' '' '',
                        'MATNR' 'Material Code' '' 'VBRP',
                        'ARKTX' 'Mat Description' '' '',
                        'STEUC' 'HSN Code' '' '',
                        'CHARG' 'Batch' '' '',
                        'VRKME' 'UoM' '' '',
                        'RPET' 'R-PET' '' '',
                        'BROKER_CODE' 'Broker Code' '' '',
                        'ZZPDAMT' 'PD Rate' '' '',
                        'BROKER' 'Broker' '' '',
                        'SALES_PERSON' 'Sales Person' '' '',
                        'KUNNR' 'Ship to party' '' '',
                        'ZNAME1' 'Ship to party name' '' ''.

  PERFORM fcat USING  :
                        'FKIMG' 'Bill Qty' ' ' '',
                        'KURSK' 'Exch. rate' ' ' '',
                        'RATE'  'Rate' '' '',
                        'NETWR' 'Net Value' '' '',
                        'MWSBP' 'Tax' ' ' '',
                        'TOT_PRICE' 'Total Value' '' '',
                        'CGSTR' 'CGST Rate' '' '',
                        'CGST' 'CGST Value' '' '',
                        'SGSTR' 'SGST Rate' '' '',
                        'SGST' 'SGST Value' '' '',
                        'UGSTR' 'UGST Rate' '' '',
                        'UGST' 'UGST Value' '' '',
                        'IGSTR' 'IGST Rate' '' '',
                        'IGST' 'IGST Value' '' '',
                        'JTC1R' 'TCS Rate' '' '',
                        'JTC1' 'TCS' '' '',
                        'JTC2R' 'TCS Scrap Rate' '' '',
                        'JTC2' 'TCS Scrap' '' ''.

  PERFORM fcat USING  :
                        'ZTERM' 'Payment Terms' '' '',
                        'D_SHADE_NO' 'Shade No' '' '',
                        'D_SHADE_NAME' 'Shade Name' '' '',
                        'D_DYEING_PROCESS' 'DYEING PROCESS' '' '' ,
                        'IRN' 'IRN' '' '',
                        'ACK_NO' 'Ack No' '' '',
                        'ACK_DATE' 'Ack Date' '' '',
                        'EBILLNO' 'EwayBill No' '' '',
                        'EXTWG' 'Ext. Material Group' '' '',
                        'BLDAT' 'Delivery Date.' '' ''.

  ls_layout-zebra = 'X'.
  ls_layout-colwidth_optimize = 'X'.
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program = 'SY-REPID'
      is_layout          = ls_layout
      it_fieldcat        = lt_fcat
      i_save             = 'A'
    TABLES
      t_outtab           = it_data
    EXCEPTIONS
      program_error      = 1
      OTHERS             = 2.
  IF sy-subrc <> 0.
  ENDIF.

FORM fcat  USING    VALUE(p_1)
                    VALUE(p_2)
                    VALUE(p_3)
                    VALUE(p_4).
  ls_fcat-fieldname = p_1.
  ls_fcat-seltext_l = p_2.
  ls_fcat-lzero = p_3.
  ls_fcat-ref_tabname = p_4.
  APPEND ls_fcat TO lt_fcat.
  CLEAR ls_fcat.


ENDFORM.