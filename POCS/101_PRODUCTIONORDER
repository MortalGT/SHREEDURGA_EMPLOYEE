DATA lt_items TYPE TABLE FOR CREATE i_materialdocumenttp\_materialdocumentitem.

lt_items = VALUE #( (
  %cid_ref = 'CID_001'
  %target  = VALUE #(
    " ---------------------------------------------------------------------
    " Item 1: Movement 101 (Receipt from Production Order)
    " ---------------------------------------------------------------------
    ( %cid                       = 'CID_ITM_101_PROD'
      plant                      = '1300'
      material                   = 'FBPDDT006760000-00'       " Material produced
      batch                      = '0000000525'
      goodsmovementtype          = '101'
      storagelocation            = '1311'
      quantityinentryunit        = '10'
      entryunit                  = 'M'
      goodsmovementrefdoctype    = 'F'                        " F = Order
      manufacturingorder         = '000010000123'             " <--- REPLACE WITH YOUR PRODUCTION ORDER
      manufacturingorderitem     = '0001'                     " <--- REPLACE WITH YOUR ORDER ITEM (usually set if needed)
      " Note: materialdocumentline might be auto-calculated or needed depending on version. 
      " Keeping it optional or low number.

      " Control Flags
      %control-plant             = cl_abap_behv=>flag_changed
      %control-material          = cl_abap_behv=>flag_changed
      %control-batch             = cl_abap_behv=>flag_changed
      %control-goodsmovementtype = cl_abap_behv=>flag_changed
      %control-storagelocation   = cl_abap_behv=>flag_changed
      %control-quantityinentryunit = cl_abap_behv=>flag_changed
      %control-entryunit           = cl_abap_behv=>flag_changed
      %control-goodsmovementrefdoctype = cl_abap_behv=>flag_changed
      %control-manufacturingorder  = cl_abap_behv=>flag_changed
      %control-manufacturingorderitem = cl_abap_behv=>flag_changed
    )
  )
) ).

MODIFY ENTITIES OF i_materialdocumenttp
    ENTITY materialdocument
    CREATE FROM VALUE #( ( %cid = 'CID_001'
    goodsmovementcode          = '02'   " 02 = Goods Receipt for Order (MB31)
    postingdate                = sy-datum
    documentdate               = sy-datum
    %control-goodsmovementcode = cl_abap_behv=>flag_changed
    %control-postingdate       = cl_abap_behv=>flag_changed
    %control-documentdate      = cl_abap_behv=>flag_changed
    ) )
    ENTITY materialdocument
    CREATE BY \_materialdocumentitem
    FROM lt_items
    MAPPED DATA(ls_create_mapped)
    FAILED DATA(ls_create_failed)
    REPORTED DATA(ls_create_reported).

    COMMIT ENTITIES
      RESPONSE OF i_materialdocumenttp
      FAILED   DATA(ls_cfailed)
      REPORTED DATA(ls_creport).

    DATA: lv_final_msg TYPE string.
    " 1. Handling Item Errors
    LOOP AT ls_creport-materialdocumentitem INTO DATA(ls_item_err).
      IF ls_item_err-%msg IS BOUND.
        DATA(lv_text) = ls_item_err-%msg->if_message~get_text( ).
        IF lv_final_msg IS INITIAL.
          lv_final_msg = lv_text.
        ELSE.
          lv_final_msg = |{ lv_final_msg }, { lv_text }|.
        ENDIF.
      ENDIF.
    ENDLOOP.
    " 2. Handling Header Errors
    LOOP AT ls_creport-materialdocument INTO DATA(ls_head_err).
      IF ls_head_err-%msg IS BOUND.
        lv_text = ls_head_err-%msg->if_message~get_text( ).
        IF lv_final_msg IS INITIAL.
          lv_final_msg = lv_text.
        ELSE.
          lv_final_msg = |{ lv_final_msg }, { lv_text }|.
        ENDIF.
      ENDIF.
    ENDLOOP.

    IF lv_final_msg IS NOT INITIAL.
      out->write( lv_final_msg ).
    ELSE.
      out->write( 'Document Posted Successfully' ).
      " Optional: Output the new Material Document Number from Mapped
      LOOP AT ls_create_mapped-materialdocument INTO DATA(ls_mapped_doc).
         out->write( |Material Document: { ls_mapped_doc-MaterialDocument }| ).
      ENDLOOP.
    ENDIF.